<!--
Ohana Party Card Game - Single-file HTML/CSS/JS
Complete, cleaned version. Fixes previous syntax issues and includes:
- player cards log popup (open from button under footer)
- smoke tests (add players, build deck, shuffle, deal)
- defensive null checks for DOM elements
- no stray `function` tokens inside execution context
-->

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>By Bey-Party Card Game</title>
  <style>
    :root{--bg:#0f172a;--card:#fff;--accent:#f97316;--muted:#94a3b8}
    body{font-family:Inter,system-ui,Arial; margin:0; background:linear-gradient(180deg,#071024 0%, #0b1220 100%); color:#e6eef8; display:flex; min-height:100vh; align-items:center; justify-content:center; padding:20px}
    .app{width:100%; max-width:980px; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    header{display:flex; gap:12px; align-items:center; margin-bottom:14px}
    header h1{font-size:20px; margin:0}
    .controls{display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
    input[type=text]{padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:inherit}
    button{background:var(--accent); border:0; padding:8px 12px; border-radius:8px; color:#fff; cursor:pointer}
    button.ghost{background:transparent; border:1px solid rgba(255,255,255,0.06)}
    .layout{display:grid; grid-template-columns:320px 1fr; gap:16px}
    .panel{background:rgba(255,255,255,0.02); padding:12px; border-radius:10px}
    .players{display:flex; flex-direction:column; gap:8px}
    .player-row{display:flex; gap:8px; align-items:center}
    .player-name{flex:1}
    .deck{display:flex; gap:12px; align-items:center; justify-content:center; padding:20px}
    .card{width:160px; height:220px; border-radius:10px; background:linear-gradient(180deg,#fff 0%, #f8fafc 100%); color:#071024; display:flex; flex-direction:column; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(2,6,23,0.5)}
    .card.small{width:80px;height:110px}
    .rank{font-size:44px; font-weight:700}
    .suit{font-size:22px}
    .action{margin-top:10px; font-weight:600; text-align:center}
    .history{max-height:260px; overflow:auto; font-size:14px}
    .action-sets{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    label{font-size:13px; color:var(--muted)}
    textarea{width:100%; min-height:80px; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:inherit}
    footer{margin-top:12px; display:flex; justify-content:space-between; align-items:center; font-size:13px; color:var(--muted)}
    @media (max-width:880px){.layout{grid-template-columns:1fr;}} 

    /* popup styles */
    #cardLogPopup{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(3px); align-items:center; justify-content:center}
    #cardLogPopup .modal{background:#0f172a; padding:18px; border-radius:12px; width:90%; max-width:480px; max-height:80%; overflow:auto; box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    #cardLogPopup .modal h3{margin-top:0}
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <h1> Party Card Game (‡ªÄ‡∫ß‡∫¥‡∫ä‡∫±‡ªâ‡∫ô‡∫ó‡∫ª‡∫î‡∫•‡∫≠‡∫á)</h1>
      <div style="margin-left:auto;color:var(--muted)">‡∫õ‡∫±‡∫ö‡ªÄ‡ªÄ‡∫ï‡ªà‡∫á‡∫Å‡∫ª‡∫î‡ªÑ‡∫î‡ªâ ‚Ä¢ ‡∫Ç‡ªç‡ªÉ‡∫´‡ªâ‡∫°‡ªà‡∫ß‡∫ô </div>
    </header>

    <div class="controls">
      <div>
        <input id="playerName" type="text" placeholder="‡ªÄ‡∫û‡∫¥‡ªà‡∫°‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô ‡ªÅ‡∫•‡ªâ‡∫ß‡∫Å‡∫ª‡∫î +" aria-label="player name">
        <button id="addPlayerBtn">+</button>
        <button id="autoPlayers" class="ghost">‡ªÄ‡∫û‡∫¥‡ªà‡∫°‡∫ï‡∫ª‡∫ß‡∫¢‡ªà‡∫≤‡∫á‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô 4 ‡∫Ñ‡∫ª‡∫ô</button>
      </div>
      <div>
        <button id="startBtn">‡ªÄ‡∫•‡∫¥‡ªà‡∫°‡ªÄ‡∫Å‡∫° (‡∫™‡∫±‡∫ö‡ªÑ‡∫û‡ªâ)</button>
        <button id="resetBtn" class="ghost">‡ªÄ‡∫•‡∫¥‡ªà‡∫°‡ªÉ‡ªù‡ªà</button>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
        <label style="margin-right:6px">‡∫ä‡∫∏‡∫î‡ªÑ‡∫û‡ªâ:</label>
        <select id="deckType">
          <option value="standard">52 ‡ªÉ‡∫ö (‡ªÅ‡∫ô‡∫∞‡∫ô‡∫≥)</option>
          <option value="mini">12 ‡ªÉ‡∫ö (‡∫ï‡∫ª‡∫ß‡∫¢‡ªà‡∫≤‡∫á)</option>
        </select>
      </div>
    </div>

    <div class="layout">
      <aside class="panel">
        <h3>‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô</h3>
        <div class="players" id="playersList">
          <!-- player rows -->
        </div>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <!-- <button id="prevTurn" class="ghost">‡∏¢‡πâ‡∏≠‡∏ô‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô</button> -->
          <button id="nextTurn">‡ªÅ‡∫à‡∫Å‡ªÑ‡∫û‡ªâ</button>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
        <h4>‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡ªà‡∫∞</h4>
        <div class="history" id="history"></div>
      </aside>

      <main class="panel">
        <div class="deck">
          <div>
            <div id="deckPile" class="card small" title="‡πÑ‡∏û‡πà‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠">--</div>
            <div style="text-align:center; margin-top:6px; color:var(--muted); font-size:13px">‡ªÑ‡∫û‡ªâ‡∫ó‡∫µ‡ªà‡ªÄ‡∫´‡∫º‡∫∑‡∫≠: <span id="leftCount">0</span></div>
          </div>

          <div id="currentCard" class="card">
            <div class="rank" id="cardRank">?</div>
            <div class="suit" id="cardSuit">?</div>
            <div class="action" id="cardAction">‡ªÉ‡∫´‡ªâ‡∫Å‡∫ª‡∫î"‡ªÅ‡∫à‡∫Å‡ªÑ‡∫û‡ªâ"‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫õ‡∫¥‡∫î</div>
          </div>
        </div>

        <section style="margin-top:12px">
          <h3>‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤ (‡∫Å‡∫≥‡∫ô‡∫ª‡∫î‡ªÑ‡∫î‡ªâ)</h3>
          <div class="action-sets">
            <div>
              <label>‡∫ü‡∫±‡∫á‡∫ä‡∫±‡ªâ‡∫ô‡∫Ç‡∫≠‡∫á‡ªÑ‡∫û‡ªâ‡ªÅ‡∫ï‡ªà‡∫•‡ªà‡∫∞‡ªÉ‡∫ö :</label>
              <textarea id="rulesText">A: ‡ªÇ‡∫î‡∫ô‡∫Ñ‡∫ª‡∫ô‡∫î‡∫Ω‡∫ß
2: ‡∫´‡∫≤‡ªù‡∫π‡ªà‡ªÇ‡∫î‡∫ô‡∫ô‡∫≥ 1 ‡∫Ñ‡∫ª‡∫ô
3: ‡∫´‡∫≤‡ªù‡∫π‡ªà‡ªÇ‡∫î‡∫ô‡∫ô‡∫≥ 2 ‡∫Ñ‡∫ª‡∫ô
4: ‡∫Ñ‡∫ª‡∫ô‡∫¢‡∫π‡ªà‡∫Ç‡ªâ‡∫≤‡∫á‡∫ä‡ªâ‡∫≤‡∫ç‡ªÇ‡∫î‡∫ô
5: ‡ªÇ‡∫î‡∫ô‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô
6: ‡∫Ñ‡∫ª‡∫ô‡∫¢‡∫π‡ªà‡∫Ç‡ªâ‡∫≤‡∫á‡∫Ç‡∫ß‡∫≤‡ªÇ‡∫î‡∫ô
7: ‡∫î‡∫ß‡∫ô‡∫õ‡∫≠‡∫î ‡∫´‡∫≤‡∫Ñ‡∫π‡ªà‡∫õ‡∫∞‡∫•‡∫≠‡∫á ‡ªÉ‡∫ú‡∫•‡∫≤‡∫Å‡∫™‡∫Ω‡∫á‡∫ç‡∫≤‡∫ß‡∫™‡∫∏‡∫î‡∫ä‡ªà‡∫∞‡∫ô‡ªà‡∫∞
8: Relax (‡∫û‡∫±‡∫Å‡∫ú‡ªà‡∫≠‡∫ô‡ªÑ‡∫î‡ªâ‡∫ï‡∫≤‡∫°‡∫™‡∫∞‡∫ö‡∫≤‡∫ç3‡∫ô‡∫≤‡∫ó‡∫µ)
9: ‡∫°‡∫¥‡∫ô‡∫¥‡ªÄ‡∫Å‡∫° (‡∫Å‡∫≥‡∫ô‡∫ª‡∫î‡ªÑ‡∫î‡ªâ‡ªÄ‡∫≠‡∫á)
10: ‡ªÄ‡∫•‡∫∞‡ªÉ‡∫ä‡ªâ‡ªÅ‡∫õ‡ªâ‡∫á‡ªÇ‡∫õ‡∫∞‡ªú‡ªâ‡∫≤
J: ‡∫à‡∫±‡∫ö‡ªú‡ªâ‡∫≤ (‡ªÉ‡∫ú‡ªâ‡∫à‡∫±‡∫ö‡ªú‡ªâ‡∫≤‡∫ï‡∫≤‡∫°‡∫ú‡∫π‡ªâ‡∫ñ‡∫∑‡ªÑ‡∫û‡ªâ‡∫Ñ‡∫ª‡∫ô‡∫™‡∫∏‡∫î‡∫ó‡ªâ‡∫≤‡∫ç‡ªÇ‡∫î‡∫ô)
Q: ‡ªÅ‡ªù‡ªà‡∫°‡ªù‡∫π‡ªà‡∫ö‡ªç‡ªà‡∫Ñ‡∫ª‡∫ö (‡ªÉ‡∫ú‡ªÄ‡∫ß‡∫ª‡ªâ‡∫≤‡∫ô‡∫≥‡∫Ñ‡∫ª‡∫ô‡∫ñ‡∫∑‡ªÑ‡∫û‡ªâ‡ªÉ‡∫ö‡∫ô‡∫µ‡ªâ‡ªÇ‡∫î‡∫ô‡∫´‡∫º‡∫∑‡∫ï‡∫≠‡∫ö‡∫Å‡∫±‡∫ö‡∫î‡ªâ‡∫ß‡∫ç‡∫ó‡ªà‡∫≤‡∫ó‡∫≤‡∫á‡ªÇ‡∫î‡∫ô)
K: ‡∫¢‡∫∑‡∫ô‡∫Ç‡∫∂‡ªâ‡∫ô‡∫´‡ªâ‡∫≤‡∫°‡∫ô‡∫±‡ªà‡∫á (‡ªÄ‡∫û‡∫¥‡ªà‡∫°‡ªú‡ªâ‡∫≤‡∫ó‡∫µ‡ªà‡ªÑ‡∫î‡ªâ‡∫ß‡ªà‡∫≤‡ªÉ‡∫´‡ªâ‡ªÄ‡∫Æ‡∫±‡∫î‡∫´‡∫ç‡∫±‡∫á‡∫ô‡∫≥‡∫ñ‡ªâ‡∫≤‡∫ù‡ªà‡∫≤‡∫ù‡∫∑‡∫ô‡ªÇ‡∫î‡∫ô)
</textarea>
            </div>
            <div>
              <label>‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î:</label>
              <textarea id="notes">‡∫Å‡∫≥‡∫ô‡∫ª‡∫î‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫°‡ªÉ‡∫ô‡∫ä‡ªà‡∫≠‡∫á‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤‡ªÑ‡∫î‡ªâ‡∫ï‡∫≤‡∫°‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô ‚Äî ‡ªÅ‡∫ï‡ªà‡∫•‡ªà‡∫∞‡∫ö‡∫±‡∫ô‡∫ó‡∫±‡∫î‡ªÉ‡∫ô‡∫Æ‡∫π‡∫ö‡ªÅ‡∫ö‡∫ö "RANK: ‡∫Ñ‡∫≥‡∫≠‡∫∞‡∫ó‡∫¥‡∫ö‡∫≤‡∫ç"‡ªÄ‡∫ä‡∫±‡ªà‡∫ô" K: ‡∫¢‡∫∑‡∫ô‡∫Ç‡∫∂‡ªâ‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß‡∫Å‡∫≥‡∫ô‡∫ª‡∫î‡∫Å‡∫ª‡∫î‡∫à‡∫ª‡∫ô‡∫Å‡ªà‡∫ß‡∫≤‡∫Ñ‡∫ª‡∫ô‡∫ï‡ªç‡ªà‡ªÑ‡∫õ"</textarea>
            </div>
          </div>

          <div style="margin-top:10px; display:flex; gap:8px;">
            <button id="applyRules">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤</button>
            <button id="exportRules" class="ghost">‡∫Ñ‡∫±‡∫î‡∫•‡∫≠‡∫Å‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤</button>
            <button id="resetRules" class="ghost">‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤‡∫î‡∫±‡ªâ‡∫á‡ªÄ‡∫î‡∫¥‡∫°</button>
          </div>
        </section>

      </main>
    </div>

    <footer>
      <div>‡∫Ñ‡∫π‡ªà‡∫°‡∫∑: ‡ªÄ‡∫û‡∫¥‡ªà‡∫°‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô ‚Üí ‡∫Å‡∫ª‡∫î‡ªÄ‡∫•‡∫¥‡ªà‡∫°‡ªÄ‡∫Å‡∫° ‚Üí ‡∫Å‡∫ª‡∫î‡ªÅ‡∫à‡∫Å‡ªÑ‡∫û‡ªâ ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫õ‡∫¥‡∫î‡ªÑ‡∫û‡ªâ‡ªÄ‡ªÄ‡∫ï‡ªà‡∫•‡ªà‡∫∞‡ªÉ‡∫ö</div>
      <div>‡ªÄ‡∫ß‡∫¥‡∫ä‡∫±‡ªâ‡∫ô‡∫ó‡∫ª‡∫î‡∫•‡∫≠‡∫á by BeyBie</div>
    </footer>

    <div style="text-align:center; margin-top:10px;"><button id="cardLogListBtn" class="ghost">‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡ªÑ‡∫û‡ªâ‡∫Ç‡∫≠‡∫á‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô</button></div>

    <!-- Smoke Test Button -->
    <div style="margin-top:12px; text-align:center;">
      <button id="runTests" class="ghost">‡∫ó‡∫ª‡∫î‡∫™‡∫≠‡∫ö‡∫•‡ªà‡∫∞‡∫ö‡∫ª‡∫ö (Run Test)</button>
      <div id="testResults" style="margin-top:8px; font-size:14px; color:var(--muted)"></div>
    </div>
    <footer>
        <div>
            ‡∫ú‡∫π‡ªâ‡∫™‡ªâ‡∫≤‡∫á‡∫ú‡∫π‡ªâ‡∫û‡∫±‡∫î‡∫ó‡∫∞‡∫ô‡∫≤=<p>FB:<a href="https://www.facebook.com/BayGamerZ/">xaypadid phetpaseuth</a></p>
            <p>IG:<a href="https://www.instagram.com/bey_bie_?igsh=MWlyNmRkZ24xazdoYw%3D%3D&utm_source=qr">@Bey_Bie_</a></p>
        </div>
        <div>
            ‡ªÄ‡∫Å‡∫°‡∫ï‡∫ª‡ªâ‡∫ô‡∫™‡∫∞‡∫ö‡∫±‡∫ö‡ªÅ‡∫•‡∫∞‡ªÅ‡∫Æ‡∫á‡∫ö‡∫±‡∫ô‡∫î‡∫≤‡∫ô‡ªÉ‡∫à=<p>YT:<a href="https://youtu.be/9MTUJmXGZBw?si=A98-6AdM1lK8QHev">OHANA</a></p>
        </div>
        <!-- <div>‡∫ú‡∫π‡ªâ‡∫™‡ªâ‡∫≤‡∫á‡∫ú‡∫π‡ªâ‡∫û‡∫±‡∫î‡∫ó‡∫∞‡∫ô‡∫≤=FB:xaypadid phetpaseuth</div>
        <div>‡ªÄ‡∫Å‡∫°‡∫ï‡∫ª‡ªâ‡∫ô‡∫™‡∫∞‡∫ö‡∫±‡∫ö‡ªÅ‡∫•‡∫∞‡ªÅ‡∫Æ‡∫á‡∫ö‡∫±‡∫ô‡∫î‡∫≤‡∫ô‡ªÉ‡∫à= OHANA </div> -->
    </footer>
  </div>

  <!-- Popup for card log -->
  <div id="cardLogPopup">
    <div class="modal">
      <h3>‡ªÑ‡∫û‡ªâ‡∫ó‡∫µ‡ªà‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡ªÅ‡∫ï‡ªà‡∫•‡ªà‡∫∞‡∫Ñ‡∫ª‡∫ô‡ªÑ‡∫î‡ªâ‡∫Æ‡∫±‡∫ö</h3>
      <div id="cardLogList" style="margin-top:10px; font-size:15px; line-height:1.5"></div>
      <button id="closeCardLog" style="margin-top:15px; width:100%" class="ghost">‡∫õ‡∫¥‡∫î</button>
    </div>
  </div>

  <script>
    // Data model
    const ranksFull = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    const suits = ['‚ô†','‚ô•','‚ô¶','‚ô£'];

    let players = []; // each player: {name, cards: []}
    let deck = [];
    let discard = [];
    let currentPlayerIndex = 0;
    let rules = {};

    // DOM helpers (guarded queries)
    const $ = (id)=>document.getElementById(id);
    const playersList = $('playersList');
    const playerNameInput = $('playerName');
    const addPlayerBtn = $('addPlayerBtn');
    const autoPlayersBtn = $('autoPlayers');
    const startBtn = $('startBtn');
    const resetBtn = $('resetBtn');
    const deckType = $('deckType');
    const leftCount = $('leftCount');
    const deckPile = $('deckPile');
    const cardRank = $('cardRank');
    const cardSuit = $('cardSuit');
    const cardAction = $('cardAction');
    const historyEl = $('history');
    const nextTurnBtn = $('nextTurn');
    const prevTurnBtn = $('prevTurn');
    const rulesText = $('rulesText');
    const applyRulesBtn = $('applyRules');
    const exportRulesBtn = $('exportRules');
    const resetRulesBtn = $('resetRules')
    const runTestsBtn = $('runTests');
    const testResults = $('testResults');
    const cardLogListBtn = $('cardLogListBtn');
    const cardLogPopup = $('cardLogPopup');
    const cardLogList = $('cardLogList');
    const closeCardLog = $('closeCardLog');

    function renderPlayers(){
      if(!playersList) return;
      playersList.innerHTML = '';
      players.forEach((p, i)=>{
        const row = document.createElement('div'); row.className='player-row';
        const name = document.createElement('div'); name.className='player-name'; name.textContent = (i===currentPlayerIndex? 'üëâ ':'') + p.name;
        const remove = document.createElement('button'); remove.className='ghost'; remove.textContent='x';
        remove.onclick = ()=>{ players.splice(i,1); if(currentPlayerIndex>=players.length) currentPlayerIndex = Math.max(0, players.length-1); renderPlayers(); }
        row.appendChild(name); row.appendChild(remove);
        playersList.appendChild(row);
      });
      if(players.length===0 && playersList) playersList.innerHTML='<div style="color:var(--muted)">‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ú‡∫π‡ªâ‡ªÄ‡∫•‡ªà‡∫ô ‚Äî ‡ªÄ‡∫û‡∫¥‡ªà‡∫°‡∫ä‡∫∑‡ªà‡∫î‡ªâ‡∫≤‡∫ô‡ªÄ‡∫ó‡∫¥‡∫á</div>'
    }

    function addPlayer(name){ if(!name) return; players.push({name: name, cards: []}); if(playerNameInput) playerNameInput.value=''; renderPlayers(); }
    addPlayerBtn && addPlayerBtn.addEventListener('click', ()=> addPlayer((playerNameInput && playerNameInput.value.trim()) || 'Player'));
    autoPlayersBtn && autoPlayersBtn.addEventListener('click', ()=>{ ['Bot1','Bot2','Bot3','Bot4'].forEach(n=>addPlayer(n)); });

    function buildDeck(type){
      const arr = [];
      if(type==='mini'){
        for(let i=0;i<12;i++){ arr.push({rank:ranksFull[i%ranksFull.length], suit:suits[i%4]}); }
      } else {
        suits.forEach(s=> ranksFull.forEach(r=> arr.push({rank:r, suit:s})))
      }
      return arr;
    }

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } }

    function startGame(){
      deck = buildDeck(deckType ? deckType.value : 'standard');
      shuffle(deck);
      discard = [];
      currentPlayerIndex = 0;
      updateLeftCount();
      log('‡ªÄ‡∫•‡∫¥‡ªà‡∫°‡ªÄ‡∫Å‡∫° ‚Äî ‡ªÑ‡∫û‡ªâ‡∫ñ‡∫∑‡∫Å‡∫™‡∫±‡∫ö‡ªÄ‡ªÄ‡∫•‡ªâ‡∫ß');
      renderPlayers();
      showBackCard();
    }

    function resetGame(){ players=[]; deck=[]; discard=[]; currentPlayerIndex=0; rules={}; renderPlayers(); updateLeftCount(); showBackCard(); if(historyEl) historyEl.innerHTML=''; if(cardAction) cardAction.textContent='‡ªÉ‡∫´‡ªâ‡∫Å‡∫ª‡∫î"‡ªÅ‡∫à‡∫Å‡ªÑ‡∫û‡ªâ"‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫õ‡∫¥‡∫î'; }

    function updateLeftCount(){ if(leftCount) leftCount.textContent = deck.length; if(deckPile) deckPile.textContent = deck.length; }

    function showBackCard(){ if(cardRank) cardRank.textContent='?'; if(cardSuit) cardSuit.textContent=''; if(cardAction) cardAction.textContent='‡ªÉ‡∫´‡ªâ‡∫Å‡∫ª‡∫î"‡ªÅ‡∫à‡∫Å‡ªÑ‡∫û‡ªâ"‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫õ‡∫¥‡∫î'; }

    // dealCard as a stable function (no stray 'function' inside execution)
    function dealCard(){
      if(deck.length===0){ alert('‡ªÑ‡∫û‡ªâ‡ªù‡∫ª‡∫î‡∫™‡∫≥‡∫•‡∫±‡∫ö‡ªÄ‡ªÄ‡∫•‡ªâ‡∫ß ‚Äî ‡ªÉ‡∫´‡ªâ‡∫Å‡∫ª‡∫î‡ªÄ‡∫•‡∫¥‡ªà‡∫°‡ªÉ‡ªù‡ªà‡∫´‡∫º‡∫∑‡∫•‡∫µ‡ªÄ‡∫ä‡∫±‡∫î'); return; }
      const card = deck.shift();
      discard.unshift(card);
      updateLeftCount();
      displayCard(card);

      const action = getActionForRank(card.rank);
      const player = players[currentPlayerIndex] || {name:'(‡∫Ñ‡∫ª‡∫ô‡∫ó‡∫µ '+(currentPlayerIndex+1)+')', cards: []};

      // record to player's card log
      if(player.cards) player.cards.push(card);
      updateCardLogPopup();

      const entry = `${player.name} ‡ªÄ‡∫õ‡∫¥‡∫î ${card.rank}${card.suit} ‚Äî ${action}`;
      log(entry);

      // advance turn
      currentPlayerIndex = (currentPlayerIndex + 1) % Math.max(1, players.length);
      renderPlayers();
    }

    function displayCard(card){ if(cardRank) cardRank.textContent = card.rank; if(cardSuit) cardSuit.textContent = card.suit; if(cardAction) cardAction.textContent = getActionForRank(card.rank); }

    function getActionForRank(rank){ return rules[rank] || '‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡∫Å‡∫≥‡∫ô‡∫ª‡∫î‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤'; }

    function log(text){ if(!historyEl) return; const el = document.createElement('div'); el.textContent = '['+new Date().toLocaleTimeString()+'] '+text; historyEl.prepend(el); }

    if(nextTurnBtn) nextTurnBtn.addEventListener('click', ()=> dealCard());
    if(prevTurnBtn) prevTurnBtn.addEventListener('click', ()=>{ // undo: move last discard back to deck
      if(discard.length===0){ alert('‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡ªÑ‡∫û‡ªâ‡ªÄ‡∫õ‡∫¥‡∫î'); return; }
      const last = discard.shift(); deck.unshift(last); currentPlayerIndex = (currentPlayerIndex-1 + Math.max(1,players.length)) % Math.max(1,players.length); updateLeftCount(); log('‡∫ç‡ªâ‡∫≠‡∫ô‡∫Å‡∫±‡∫ö: ‡∫ô‡∫≥‡ªÑ‡∫û‡ªâ‡∫Å‡∫±‡∫ö‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫Å‡∫≠‡∫á'); showBackCard(); renderPlayers(); });

    if(startBtn) startBtn.addEventListener('click', ()=> startGame());
    if(resetBtn) resetBtn.addEventListener('click', ()=>{ if(confirm('‡∫•‡∫µ‡ªÄ‡∫ä‡∫±‡∫î‡ªÄ‡∫Å‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î?')) resetGame(); });

    if(applyRulesBtn) applyRulesBtn.addEventListener('click', ()=>{
      rules = {};
      const lines = (rulesText ? rulesText.value : '').split('\n');
      lines.forEach(line=>{
        const idx = line.indexOf(':'); if(idx===-1) return; const k = line.slice(0,idx).trim(); const v = line.slice(idx+1).trim(); if(k) rules[k]=v;
      });
      log('‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤‡ªÉ‡ªù‡ªà‡∫ñ‡∫∑‡∫Å‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß');
      alert('‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤‡∫ñ‡∫∑‡∫Å‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÄ‡ªÄ‡∫•‡ªâ‡∫ß');
    });

    if(exportRulesBtn) exportRulesBtn.addEventListener('click', ()=>{ navigator.clipboard.writeText(rulesText ? rulesText.value : '').then(()=>alert('‡∫ï‡∫±‡∫î‡∫•‡∫≠‡∫Å‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤‡ªÄ‡ªÄ‡∫•‡ªâ‡∫ß')); });

    if(resetRulesBtn) resetRulesBtn.addEventListener('click', ()=>{
if(rulesText){
rulesText.value = `A: ‡ªÇ‡∫î‡∫ô‡∫Ñ‡∫ª‡∫ô‡∫î‡∫Ω‡∫ß
2: ‡∫´‡∫≤‡ªù‡∫π‡ªà‡ªÇ‡∫î‡∫ô‡∫ô‡∫≥ 1 ‡∫Ñ‡∫ª‡∫ô
3: ‡∫´‡∫≤‡ªù‡∫π‡ªà‡ªÇ‡∫î‡∫ô‡∫ô‡∫≥ 2 ‡∫Ñ‡∫ª‡∫ô
4: ‡∫Ñ‡∫ª‡∫ô‡∫¢‡∫π‡ªà‡∫Ç‡ªâ‡∫≤‡∫á‡∫ä‡ªâ‡∫≤‡∫ç‡ªÇ‡∫î‡∫ô
5: ‡ªÇ‡∫î‡∫ô‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô
6: ‡∫Ñ‡∫ª‡∫ô‡∫¢‡∫π‡ªà‡∫Ç‡ªâ‡∫≤‡∫á‡∫Ç‡∫ß‡∫≤‡ªÇ‡∫î‡∫ô
7: ‡∫î‡∫ß‡∫ô‡∫õ‡∫≠‡∫î ‡∫´‡∫≤‡∫Ñ‡∫π‡ªà‡∫õ‡∫∞‡∫•‡∫≠‡∫á ‡ªÉ‡∫ú‡∫•‡∫≤‡∫Å‡∫™‡∫Ω‡∫á‡∫ç‡∫≤‡∫ß‡∫™‡∫∏‡∫î‡∫ä‡ªà‡∫∞‡∫ô‡ªà‡∫∞
8: Relax (‡∫û‡∫±‡∫Å‡∫ú‡ªà‡∫≠‡∫ô‡ªÑ‡∫î‡ªâ‡∫ï‡∫≤‡∫°‡∫™‡∫∞‡∫ö‡∫≤‡∫ç3‡∫ô‡∫≤‡∫ó‡∫µ)
9: ‡∫°‡∫¥‡∫ô‡∫¥‡ªÄ‡∫Å‡∫° (‡∫Å‡∫≥‡∫ô‡∫ª‡∫î‡ªÑ‡∫î‡ªâ‡ªÄ‡∫≠‡∫á)
10: ‡ªÄ‡∫•‡∫∞‡ªÉ‡∫ä‡ªâ‡ªÅ‡∫õ‡ªâ‡∫á‡ªÇ‡∫õ‡∫∞‡ªú‡ªâ‡∫≤
J: ‡∫à‡∫±‡∫ö‡ªú‡ªâ‡∫≤ (‡ªÉ‡∫ú‡ªâ‡∫à‡∫±‡∫ö‡ªú‡ªâ‡∫≤‡∫ï‡∫≤‡∫°‡∫ú‡∫π‡ªâ‡∫ñ‡∫∑‡ªÑ‡∫û‡ªâ‡∫Ñ‡∫ª‡∫ô‡∫™‡∫∏‡∫î‡∫ó‡ªâ‡∫≤‡∫ç‡ªÇ‡∫î‡∫ô)
Q: ‡ªÅ‡ªù‡ªà‡∫°‡ªù‡∫π‡ªà‡∫ö‡ªç‡ªà‡∫Ñ‡∫ª‡∫ö (‡ªÉ‡∫ú‡ªÄ‡∫ß‡∫ª‡ªâ‡∫≤‡∫ô‡∫≥‡∫Ñ‡∫ª‡∫ô‡∫ñ‡∫∑‡ªÑ‡∫û‡ªâ‡ªÉ‡∫ö‡∫ô‡∫µ‡ªâ‡ªÇ‡∫î‡∫ô‡∫´‡∫º‡∫∑‡∫ï‡∫≠‡∫ö‡∫Å‡∫±‡∫ö‡∫î‡ªâ‡∫ß‡∫ç‡∫ó‡ªà‡∫≤‡∫ó‡∫≤‡∫á‡ªÇ‡∫î‡∫ô)
K: ‡∫¢‡∫∑‡∫ô‡∫Ç‡∫∂‡ªâ‡∫ô‡∫´‡ªâ‡∫≤‡∫°‡∫ô‡∫±‡ªà‡∫á (‡ªÄ‡∫û‡∫¥‡ªà‡∫°‡ªú‡ªâ‡∫≤‡∫ó‡∫µ‡ªà‡ªÑ‡∫î‡ªâ‡∫ß‡ªà‡∫≤‡ªÉ‡∫´‡ªâ‡ªÄ‡∫Æ‡∫±‡∫î‡∫´‡∫ç‡∫±‡∫á‡∫ô‡∫≥‡∫ñ‡ªâ‡∫≤‡∫ù‡ªà‡∫≤‡∫ù‡∫∑‡∫ô‡ªÇ‡∫î‡∫ô)`;
}
applyRulesBtn && applyRulesBtn.click();
log('‡∫•‡∫µ‡ªÄ‡∫ä‡∫±‡∫î‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤‡ªÄ‡∫õ‡∫±‡∫ô‡∫Ñ‡ªà‡∫≤‡ªÄ‡∫•‡∫¥‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô');
alert('‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤‡∫ñ‡∫∑‡∫Å‡∫•‡∫µ‡ªÄ‡∫ä‡∫±‡∫î‡ªÄ‡∫õ‡∫±‡∫ô‡∫Ñ‡ªà‡∫≤‡ªÄ‡∫•‡∫¥‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô');
});

    // Init defaults
    if(rulesText) rulesText.value = 'A: ‡ªÇ‡∫î‡∫ô‡∫Ñ‡∫ª‡∫ô‡∫î‡∫Ω‡∫ß\n2: ‡∫´‡∫≤‡ªù‡∫π‡ªà‡ªÇ‡∫î‡∫ô‡∫ô‡∫≥ 1 ‡∫Ñ‡∫ª‡∫ô\n3: ‡∫´‡∫≤‡ªù‡∫π‡ªà‡ªÇ‡∫î‡∫ô‡∫ô‡∫≥ 2 ‡∫Ñ‡∫ª‡∫ô\n4: ‡∫Ñ‡∫ª‡∫ô‡∫¢‡∫π‡ªà‡∫Ç‡ªâ‡∫≤‡∫á‡∫ä‡ªâ‡∫≤‡∫ç‡ªÇ‡∫î‡∫ô\n5: ‡ªÇ‡∫î‡∫ô‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô\n6: ‡∫Ñ‡∫ª‡∫ô‡∫¢‡∫π‡ªà‡∫Ç‡ªâ‡∫≤‡∫á‡∫Ç‡∫ß‡∫≤‡ªÇ‡∫î‡∫ô\n7: ‡∫î‡∫ß‡∫ô‡∫õ‡∫≠‡∫î ‡∫´‡∫≤‡∫Ñ‡∫π‡ªà‡∫õ‡∫∞‡∫•‡∫≠‡∫á ‡ªÉ‡∫ú‡∫•‡∫≤‡∫Å‡∫™‡∫Ω‡∫á‡∫ç‡∫≤‡∫ß‡∫™‡∫∏‡∫î‡∫ä‡ªà‡∫∞‡∫ô‡ªà‡∫∞\n8: Relax (‡∫û‡∫±‡∫Å‡∫ú‡ªà‡∫≠‡∫ô‡ªÑ‡∫î‡ªâ‡∫ï‡∫≤‡∫°‡∫™‡∫∞‡∫ö‡∫≤‡∫ç3‡∫ô‡∫≤‡∫ó‡∫µ)\n9: ‡∫°‡∫¥‡∫ô‡∫¥‡ªÄ‡∫Å‡∫° (‡∫Å‡∫≥‡∫ô‡∫ª‡∫î‡ªÑ‡∫î‡ªâ‡ªÄ‡∫≠‡∫á)\n10: ‡ªÄ‡∫•‡∫∞‡ªÉ‡∫ä‡ªâ‡ªÅ‡∫õ‡ªâ‡∫á‡ªÇ‡∫õ‡∫∞‡ªú‡ªâ‡∫≤\nJ: ‡∫à‡∫±‡∫ö‡ªú‡ªâ‡∫≤ (‡ªÉ‡∫ú‡ªâ‡∫à‡∫±‡∫ö‡ªú‡ªâ‡∫≤‡∫ï‡∫≤‡∫°‡∫ú‡∫π‡ªâ‡∫ñ‡∫∑‡ªÑ‡∫û‡ªâ‡∫Ñ‡∫ª‡∫ô‡∫™‡∫∏‡∫î‡∫ó‡ªâ‡∫≤‡∫ç‡ªÇ‡∫î‡∫ô)\nQ: ‡ªÅ‡ªù‡ªà‡∫°‡ªù‡∫π‡ªà‡∫ö‡ªç‡ªà‡∫Ñ‡∫ª‡∫ö (‡ªÉ‡∫ú‡ªÄ‡∫ß‡∫ª‡ªâ‡∫≤‡∫ô‡∫≥‡∫Ñ‡∫ª‡∫ô‡∫ñ‡∫∑‡ªÑ‡∫û‡ªâ‡ªÉ‡∫ö‡∫ô‡∫µ‡ªâ‡ªÇ‡∫î‡∫ô‡∫´‡∫º‡∫∑‡∫ï‡∫≠‡∫ö‡∫Å‡∫±‡∫ö‡∫î‡ªâ‡∫ß‡∫ç‡∫ó‡ªà‡∫≤‡∫ó‡∫≤‡∫á‡ªÇ‡∫î‡∫ô)\nK: ‡∫¢‡∫∑‡∫ô‡∫Ç‡∫∂‡ªâ‡∫ô‡∫´‡ªâ‡∫≤‡∫°‡∫ô‡∫±‡ªà‡∫á (‡ªÄ‡∫û‡∫¥‡ªà‡∫°‡ªú‡ªâ‡∫≤‡∫ó‡∫µ‡ªà‡ªÑ‡∫î‡ªâ‡∫ß‡ªà‡∫≤‡ªÉ‡∫´‡ªâ‡ªÄ‡∫Æ‡∫±‡∫î‡∫´‡∫ç‡∫±‡∫á‡∫ô‡∫≥‡∫ñ‡ªâ‡∫≤‡∫ù‡ªà‡∫≤‡∫ù‡∫∑‡∫ô‡ªÇ‡∫î‡∫ô)';
    try{ if(applyRulesBtn) applyRulesBtn.click(); }catch(e){}

    // Smoke tests
    function runSmokeTests(){
      let output = [];
      try{
        // test add player
        players = [];
        addPlayer('Test1');
        addPlayer('Test2');
        output.push(players.length===2 ? '‚úì ‡ªÄ‡∫û‡∫¥‡ªà‡∫°‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫ó‡∫≥‡∫á‡∫≤‡∫ô‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á' : '‚úó ‡ªÄ‡∫û‡∫¥‡ªà‡∫°‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î');

        // test build & shuffle deck
        let d = buildDeck('standard');
        output.push(d.length===52 ? '‚úì ‡∫™‡ªâ‡∫≤‡∫á‡∫™‡∫≥‡∫•‡∫±‡∫ö 52 ‡ªÉ‡∫ö‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á' : '‚úó ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡∫™‡∫≥‡∫•‡∫±‡∫ö‡∫ö‡ªç‡ªà‡∫Ñ‡∫ª‡∫ö');

        shuffle(d);
        output.push('‚úì ‡∫™‡∫±‡∫ö‡ªÑ‡∫û‡ªâ‡∫ó‡∫≥‡∫á‡∫≤‡∫ô (‡∫ö‡ªç‡ªà error)');

        // test deal
        deck = buildDeck('mini');
        shuffle(deck);
        discard = [];
        currentPlayerIndex = 0;
        players = [{name:'A', cards: []},{name:'B', cards: []}];
        let before = deck.length;
        dealCard();
        let after = deck.length;

        output.push(after === before-1 ? '‚úì ‡ªÅ‡∫à‡∫Å‡ªÑ‡∫û‡ªâ‡∫ó‡∫≥‡∫á‡∫≤‡∫ô‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á' : '‚úó ‡ªÅ‡∫à‡∫Å‡ªÑ‡∫û‡ªâ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ö‡ªç‡ªà‡∫•‡∫ª‡∫î');

      }catch(e){
        output.push('‚úó ERROR: '+e.message);
      }
      if(testResults) testResults.innerHTML = output.join('<br>');
    }
    if(runTestsBtn) runTestsBtn.addEventListener('click', runSmokeTests);

    // Card log popup functions
    function updateCardLogPopup(){
      if(!cardLogList) return;
      let html = '';
      players.forEach(p=>{
        html += '<div style="margin-bottom:6px"><strong>'+p.name+':</strong> '+((p.cards||[]).map(c=>c.rank+c.suit).join(', ') || '-')+'</div>';
      });
      cardLogList.innerHTML = html;
    }

    if(cardLogListBtn) cardLogListBtn.addEventListener('click', ()=>{ if(cardLogPopup) cardLogPopup.style.display = 'flex'; updateCardLogPopup(); });
    if(closeCardLog) closeCardLog.addEventListener('click', ()=>{ if(cardLogPopup) cardLogPopup.style.display = 'none'; });

    // helpful keyboard
    document.addEventListener('keydown', e=>{ if(e.key===' '){ e.preventDefault(); dealCard(); } if(e.key==='Enter'){ if(document.activeElement===playerNameInput) addPlayer((playerNameInput && playerNameInput.value.trim()) || 'Player'); } });

    // render initial
    renderPlayers(); updateLeftCount();
  </script>
  <!-- <div>

    </div> -->
</body>
</html>
